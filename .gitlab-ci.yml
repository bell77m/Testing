# GitLab CI/CD Pipeline with Test Management
# Features: Test stages, Allure reports, Slack notifications, Test metrics

image: mcr.microsoft.com/playwright/python:v1.57.0-jammy

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  ALLURE_RESULTS: "reports/allure-results"
  ALLURE_REPORT: "reports/allure-report"

stages:
  - install
  - lint
  - test_smoke
  - test_regression
  - test_security
  - report
  - deploy_report
  - notify

# Cache dependencies
cache:
  paths:
    - .cache/pip
    - .venv/

# ==================== Install Dependencies ====================
install_dependencies:
  stage: install
  script:
    - pip install --upgrade pip
    - pip install -r requirements.txt
    - playwright install --with-deps chromium
  artifacts:
    paths:
      - .venv/
    expire_in: 1 hour

# ==================== Code Quality ====================
lint_code:
  stage: lint
  script:
    - pip install black flake8 isort
    - black --check .
    - flake8 . --max-line-length=120
    - isort --check-only .
  allow_failure: true

# ==================== Smoke Tests (Fast) ====================
smoke_tests:
  stage: test_smoke
  script:
    - pip install -r requirements.txt
    - playwright install --with-deps chromium
    - pytest tests/smoke/ -m smoke --alluredir=$ALLURE_RESULTS -v
  artifacts:
    when: always
    paths:
      - $ALLURE_RESULTS
    reports:
      junit: reports/junit.xml
    expire_in: 1 week
  only:
    - main
    - master
    - merge_requests
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

# ==================== Regression Tests (Full Suite) ====================
regression_tests:
  stage: test_regression
  script:
    - pip install -r requirements.txt
    - playwright install --with-deps chromium
    - pytest tests/regression/ -m regression --alluredir=$ALLURE_RESULTS -v
  artifacts:
    when: always
    paths:
      - $ALLURE_RESULTS
      - logs/
    expire_in: 1 week
  only:
    - main
    - master
    - schedules  # For nightly runs
  allow_failure: true

# ==================== Security Tests ====================
security_tests:
  stage: test_security
  script:
    - pip install -r requirements.txt
    - playwright install --with-deps chromium
    - pytest -m security --alluredir=$ALLURE_RESULTS -v
  artifacts:
    when: always
    paths:
      - $ALLURE_RESULTS
    expire_in: 1 week
  only:
    - schedules
  allow_failure: true

# ==================== Generate Allure Report ====================
generate_allure_report:
  stage: report
  image: frankescobar/allure-docker-service:latest
  script:
    - allure generate $ALLURE_RESULTS --clean -o $ALLURE_REPORT
  artifacts:
    paths:
      - $ALLURE_REPORT
    expire_in: 30 days
  when: always
  dependencies:
    - smoke_tests
    - regression_tests
    - security_tests

# ==================== Deploy Report to GitLab Pages ====================
pages:
  stage: deploy_report
  script:
    - mkdir -p public
    - cp -r $ALLURE_REPORT/* public/
  artifacts:
    paths:
      - public
    expire_in: 30 days
  only:
    - main
    - master
  when: always

# ==================== Calculate Test Metrics ====================
test_metrics:
  stage: report
  image: python:3.11
  script:
    - pip install junitparser
    - python scripts/calculate_metrics.py
  artifacts:
    reports:
      metrics: metrics.txt
  when: always

# ==================== Slack Notification ====================
notify_slack:
  stage: notify
  image: curlimages/curl:latest
  script:
    - |
      curl -X POST $SLACK_WEBHOOK_URL \
      -H 'Content-Type: application/json' \
      -d "{
        \"text\": \"✅ Tests completed for $CI_PROJECT_NAME\",
        \"attachments\": [{
          \"color\": \"good\",
          \"fields\": [
            {\"title\": \"Branch\", \"value\": \"$CI_COMMIT_REF_NAME\", \"short\": true},
            {\"title\": \"Pipeline\", \"value\": \"#$CI_PIPELINE_ID\", \"short\": true},
            {\"title\": \"Report\", \"value\": \"$CI_PAGES_URL\", \"short\": false}
          ]
        }]
      }"
  only:
    - main
    - master
  when: on_success

notify_slack_failure:
  stage: notify
  image: curlimages/curl:latest
  script:
    - |
      curl -X POST $SLACK_WEBHOOK_URL \
      -H 'Content-Type: application/json' \
      -d "{
        \"text\": \"❌ Tests FAILED for $CI_PROJECT_NAME\",
        \"attachments\": [{
          \"color\": \"danger\",
          \"fields\": [
            {\"title\": \"Branch\", \"value\": \"$CI_COMMIT_REF_NAME\", \"short\": true},
            {\"title\": \"Pipeline\", \"value\": \"#$CI_PIPELINE_ID\", \"short\": true},
            {\"title\": \"View Logs\", \"value\": \"$CI_PIPELINE_URL\", \"short\": false}
          ]
        }]
      }"
  only:
    - main
    - master
  when: on_failure